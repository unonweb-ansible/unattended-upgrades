---
- name: unattended-upgrades role
  tags:
  - unattended-upgrades
  block:

  #- ansible.builtin.debug:
  #    msg: "{{ unattended_upgrades }}"
      
  - name: Check vars for unattended-upgrades role
    ansible.builtin.assert:
      that:
      - unattended_upgrades.config.src != None
      - unattended_upgrades.mail != None

  # apt
  - name: Apt state {{ unattended_upgrades.apt.state }}
    become: true
    ansible.builtin.apt:
      state: "{{ unattended_upgrades.apt.state }}"
      name:
      - unattended-upgrades
      - needrestart
      - powermgmt-base
  
  # template config file
  - when: unattended_upgrades.config.src != None
    name: Template 50unattended-upgrades
    become: true
    notify: Restart unattended-upgrades
    ansible.builtin.template:
      src: "{{ unattended_upgrades.config.src }}"
      dest: "{{ unattended_upgrades.config.dst }}"
      force: true # the remote file will be replaced when contents are different than the source (default) 
      owner: root
      group: root
      mode: u=rw,g=r,o=r

  # listchanges
  - when: 
    - unattended_upgrades.listchanges.apt.state != None
    - unattended_upgrades.listchanges.apt.state != "absent"
    ansible.builtin.import_tasks: listchanges.yml
  
  # apt-daily-upgrade
  - ansible.builtin.import_tasks: apt-daily-upgrade.yml

  # apt-daily
  - ansible.builtin.import_tasks: apt-daily.yml