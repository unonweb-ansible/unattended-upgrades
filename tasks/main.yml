---
- name: unattended-upgrades role
  tags:
  - unattended-upgrades
  block:

  #- ansible.builtin.debug:
  #    msg: "{{ unattended_upgrades }}"
      
  - name: Check vars for unattended-upgrades role
    ansible.builtin.assert:
      that:
      - unattended_upgrades.config.src != None

  # apt
  - name: Apt state {{ unattended_upgrades.apt.state }}
    become: true
    ansible.builtin.apt:
      state: "{{ unattended_upgrades.apt.state }}"
      name:
      - unattended-upgrades
      - needrestart
      - powermgmt-base
  
  # template config file
  - when: unattended_upgrades.config.src != None
    name: Template 50unattended-upgrades
    become: true
    notify: Restart unattended-upgrades
    ansible.builtin.template:
      src: "{{ unattended_upgrades.config.src }}"
      dest: "{{ unattended_upgrades.config.dst }}"
      force: true # the remote file will be replaced when contents are different than the source (default) 
      owner: root
      group: root
      mode: u=rw,g=r,o=r

  # listchanges
  - when: 
    - unattended_upgrades.listchanges.apt.state != None
    - unattended_upgrades.listchanges.apt.state != "absent"
    block:

    # apt listchanges
    - name: Apt state {{ unattended_upgrades.listchanges.apt.state }}
      become: true
      ansible.builtin.apt:
        state: "{{ unattended_upgrades.listchanges.apt.state }}"
        name: apt-listchanges

    # listchanges
    - when: unattended_upgrades.listchanges.config.src != None
      name: Copy listchanges.conf
      become: true
      ansible.builtin.copy:
        src: "{{ unattended_upgrades.listchanges.config.src }}"
        dest: /etc/apt/listchanges.conf
        force: true # the remote file will be replaced when contents are different than the source
        owner: root
        group: root
        mode: u=rw,g=r,o=r
  
  # apt-daily-upgrade
  - block:

    # apt-daily-upgrade.service.d
    - when: unattended_upgrades.apt_daily_upgrade.service.override != None
      block:

      # mkdir
      - name: Mkdir /etc/systemd/system/apt-daily-upgrade.service.d
        become: true
        ansible.builtin.file:
          path: /etc/systemd/system/apt-daily-upgrade.service.d
          state: directory
          owner: root
          group: root
          mode: o=rwx,g=rx,o=rx

      # cp service unit files
      - name: Copy "{{ unattended_upgrades.apt_daily_upgrade.service.override }}" to "/etc/systemd/system/apt-daily-upgrade.service.d"
        become: true
        notify: Systemd daemon-reload
        ansible.builtin.copy:
          src: "apt-daily-upgrade.service.d/{{ unattended_upgrades.apt_daily_upgrade.service.override }}"
          dest: /etc/systemd/system/apt-daily-upgrade.service.d/override.conf
          force: true
          owner: root
          group: root
          mode: u=rw,g=r,o=r
    
    # enable/disable service
    - name: Enabled {{ unattended_upgrades.apt_daily_upgrade.service.enabled }} apt-daily-upgrade.service
      become: true
      ansible.builtin.systemd_service:
        enabled: "{{ unattended_upgrades.apt_daily_upgrade.service.enabled }}"
        name: apt-daily-upgrade.service

    # apt-daily-upgrade.timer.d
    - when: unattended_upgrades.apt_daily_upgrade.timer.override != None
      block:

      # mkdir
      - name: Mkdir /etc/systemd/system/apt-daily.timer.d
        become: true
        ansible.builtin.file:
          path: /etc/systemd/system/apt-daily.timer.d
          state: directory
          owner: root
          group: root
          mode: o=rwx,g=rx,o=rx

      # cp timer unit files
      - name: Copy to /etc/systemd/system/apt-daily.timer.d/override.conf
        become: true
        notify: Systemd daemon-reload
        ansible.builtin.copy:
          src: "apt-daily-upgrade.timer.d/{{ unattended_upgrades.apt_daily_upgrade.timer.override }}"
          dest: /etc/systemd/system/apt-daily.timer.d/override.conf
          force: true
          owner: root
          group: root
          mode: u=rw,g=r,o=r

    # enable/disable timer
    - name: Enabled {{ unattended_upgrades.apt_daily_upgrade.timer.enabled }} apt-daily-upgrade.timer
      become: true
      ansible.builtin.systemd_service:
        enabled: "{{ unattended_upgrades.apt_daily_upgrade.timer.enabled }}"
        name: apt-daily.timer

  # apt-daily
  - block:

    # apt-daily.service.d
    - when: unattended_upgrades.apt_daily.service.override != None
      block:

      # mkdir
      - name: Mkdir /etc/systemd/system/apt-daily.service.d
        become: true
        ansible.builtin.file:
          path: /etc/systemd/system/apt-daily.service.d
          state: directory
          owner: root
          group: root
          mode: o=rwx,g=rx,o=rx
      
      # cp service unit files
      - name: Copy to /etc/systemd/system/apt-daily.service.d/override.conf
        become: true
        notify: Systemd daemon-reload
        ansible.builtin.copy:
          src: "apt-daily.service.d/{{ unattended_upgrades.apt_daily.service.override }}"
          dest: /etc/systemd/system/apt-daily.service.d/override.conf
          force: true
          owner: root
          group: root
          mode: u=rw,g=r,o=r

    # enable/disable service
    - name: Enabled {{ unattended_upgrades.apt_daily.service.enabled }} apt-daily.service
      become: true
      ansible.builtin.systemd_service:
        enabled: "{{ unattended_upgrades.apt_daily.service.enabled }}"
        name: apt-daily.service

    # apt-daily.timer.d
    - when: unattended_upgrades.apt_daily.timer.override != None
      block:

      # mkdir
      - name: Mkdir /etc/systemd/system/apt-daily.timer.d
        become: true
        ansible.builtin.file:
          path: /etc/systemd/system/apt-daily.timer.d
          state: directory
          owner: root
          group: root
          mode: o=rwx,g=rx,o=rx

      # cp timer unit files
      - name: Copy to /etc/systemd/system/apt-daily.timer.d/override.conf
        become: true
        notify: Systemd daemon-reload
        ansible.builtin.copy:
          src: "apt-daily.timer.d/{{ unattended_upgrades.apt_daily.timer.override }}"
          dest: /etc/systemd/system/apt-daily.timer.d/override.conf
          force: true
          owner: root
          group: root
          mode: u=rw,g=r,o=r
    
    # enable/disable timer
    - name: Enabled {{ unattended_upgrades.apt_daily.timer.enabled }} apt-daily.timer
      become: true
      ansible.builtin.systemd_service:
        enabled: "{{ unattended_upgrades.apt_daily.timer.enabled }}"
        name: apt-daily.timer